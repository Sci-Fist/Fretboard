<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Tab Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        /* Import the config file */
        /*
        @import url('./config.js');
        */

        body {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            padding: 15px;
            background-color: #121212;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better use of vertical space, especially on smaller screens */
            min-height: 98vh; /* Slightly reduced to ensure no scrollbar unless necessary */
            margin: 0;
            font-size: 16px;
        }
        /* General styles for smaller screens (phones in portrait) */
        .tab-editor {
            width: 98%; /* Take up more width, especially in landscape */
        }

        .tab-editor {
            display: flex;
            flex-direction: column;
            width: 98%; /* Default width for smaller screens */
            align-items: center;
            max-width: 1200px; /* Increased max-width for larger screens */
            margin: 10px auto; /* Added margin top/bottom for spacing */
            border: 1.5px solid #333;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            background-color: #222;
            border-radius: 10px;
        }


        .tab-display {
            margin-bottom: 15px;
            border: 1.5px solid #333;
            padding: 10px;
            min-height: 120px; /* Reduced min-height for smaller screens */
            background-color: #333;
            display: flex; /* Enable horizontal scrolling for measures */
            overflow-x: auto;
            overflow-y: auto; /* Enable vertical scrolling for very long tabs if needed */
            color: #fff;
            border-radius: 6px;
        }

        /* Media query for screens smaller than 600px (very small phones) */
        @media screen and (max-width: 600px) {
            body {
                align-items: flex-start; /* Align to top on very small screens */
                font-size: 13px; /* Further reduce base font size on very small screens */
                padding: 5px; /* Further reduce body padding for very small screens */
            }
            .tab-editor {
                padding: 5px; /* Further reduce tab-editor padding */
                border-radius: 0; /* Square corners on very small screens for more space */
                border-left: none; /* Remove left border on very small screens for more space */
                background-color: transparent; /* Make background transparent on very small screens */
            }
            .tool-bar button {
                padding: 10px 14px; /* Slightly larger button padding for touch */
                font-size: 13px; /* Further reduce button font size */
                margin-bottom: 5px; /* Reduce button margin */
            }
            .measure {
                padding: 4px; /* Further reduce measure padding */
                margin-right: 2px; /* Further reduce measure margin */
                margin-bottom: 4px; /* Further reduce margin below measures */
           }
            .fret {
                width: 35px; /* Further reduce fret width for very small screens */
                height: 35px; /* Further reduce fret height for very small screens */
                padding: 4px; /* Further reduce fret padding */
                font-size: 12px; /* Further reduce fret font size */
                margin-right: 1px; /* Further reduce fret margin */
            }
        }

        /* Media query for landscape orientation on smaller screens (typical phones) */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            body {
                align-items: center; /* Center in landscape if preferred */
                flex-direction: column; /* Keep body direction column in landscape for better vertical scrolling */
                overflow-y: auto; /* Enable vertical scrolling for body in landscape if content is too long */
            }
            .tab-editor {
                width: 98%; /* Take up almost full width in landscape */
                flex-direction: row; /* Arrange toolbar and tab display horizontally */
                align-items: flex-start; /* Align items to the start in row direction */
                justify-content: flex-start; /* Align toolbar to the start */
                padding: 5px; /* Further reduce padding in landscape */
                overflow-y: auto; /* Enable vertical scrolling for tab-editor in landscape if content is too long */
            }
            .tab-display {
                width: 75%; /* Make tab-display take up more width in landscape */
                max-height: 80vh; /* Limit tab-display height to ensure toolbar is visible */
                margin-bottom: 0; /* Remove bottom margin in landscape */
            }
            .tool-bar {
                flex-direction: column; /* Vertical toolbar in landscape */
                width: auto; /* Adjust width to content in landscape toolbar */
                margin-bottom: 0; /* Remove bottom margin for toolbar in landscape */
                margin-right: 10px; /* Add right margin to separate from tab-display */
                max-height: 80vh; /* Limit toolbar height and enable scrolling if needed */
                overflow-y: auto; /* Enable vertical scrolling for toolbar in landscape if buttons are too many */
            }
        }

        .tool-bar {
            padding: 10px;
            border: 1.5px solid #333; /* config.toolBarBorder; */
            background-color: #333;
            justify-content: flex-start; /* Align buttons to the start */
            flex-wrap: wrap;
            border-radius: 6px;
        }

        .tool-bar button {
            padding: 12px 18px; /* Adjusted button padding */
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 8px;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 6px; /* config.toolBarButtonBorderRadius; */
            transition: background-color 0.2s ease;
        }

        .tool-bar button:hover {
            background-color: #555;
        }

        /* Landscape specific toolbar styles for small screens */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .tool-bar {
                flex-direction: column; /* Vertical toolbar in landscape */
                width: auto; /* Adjust width to content in landscape toolbar */
            }
        }

        /* Media query for tablets and larger screens (min-width: 769px) */
        @media screen and (min-width: 769px) {
            body {
                align-items: center; /* Center on larger screens */
            }
            .tab-editor {
                width: 85%; /* Use default width on larger screens */
                max-width: 1000px; /* Keep max-width for larger screens */
            }
        }

        .measure {
            display: flex;
            flex-direction: column; /* Display strings vertically */
            border: 1.5px solid #333;
            padding: 8px; /* Adjusted measure padding */
            margin-right: 10px; /* config.measureMarginBottom; -> margin-right */
            margin-bottom: 10px; /* keep margin bottom for stacked rows if wrapping */
            background-color: #333;
            border-radius: 6px; /* config.measureBorderRadius; */
        }

        .string {
            display: flex;
            flex-direction: row;
            border-bottom: 1.5px solid #333;
            padding: 4px 0; /* Reduced string padding */
        }

        .fret {
            width: 55px; /* Slightly larger fret width for touch */
            height: 55px; /* Slightly larger fret height for touch */
            border: 1.5px solid #555; /* config.fretBorder; */
            padding: 8px; /* config.fretPadding; */
            margin-right: 3px;
            text-align: center;
            position: relative;
            margin-right: 3px; /* config.fretMargin; -> margin-right */
            background-color: #444;
            color: #fff;
            border-radius: 6px; /* config.fretBorderRadius; */
            font-size: 16px; /* config.fretFontSize; -> smaller font size */
            display: flex;
            cursor: pointer; /* Ensure cursor is shown for frets */
            justify-content: center;
            align-items: center;
            border: 1px solid #666; /* Add a border to the frets */
        }

        .string:last-child {
            border-right: none; /* No border for the last string in measure */
            border-bottom: none; /* No border for the last string in measure in vertical layout */
        }

        .number-circle {
            display: flex;
            position: absolute;
            top: -50px;
            left: -50px;
            width: 140px;
            height: 140px;
            justify-content: space-around;
            z-index: 10;
            border-radius: 50%; /* config.numberCircleBorderRadius; */
        }

        /*
        .second-number-circle {
            background-color: rgba(0, 200, 0, 0.5);  Semi-transparent green background for second wheel
        }
        */

        .number {
            display: flex;
            position: absolute;
            width: 40px;
            height: 40px;
            justify-content: center;
            align-items: center;
            background-color: #555;
            border-radius: 50%;
            cursor: pointer;
            animation: number-animation 0.5s forwards;
            color: #fff;
            font-size: 16px; /* config.numberFontSize; */
        }

        @keyframes number-animation {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="tab-editor">
        <!-- Tab Display Area -->
        <div class="tab-display" id="tab-display">
            <!-- Tab goes here -->
        </div>

        <!-- Tool Bar Area -->
        <div class="tool-bar">
            <button onclick="addMeasure()">Add Measure</button>
            <button onclick="clearTab()">Clear Tab</button>
            <button onclick="exportTab()">Export Tab</button>
            <button onclick="showBPMInput()">Set BPM</button>
            <button onclick="playTab()">Play Tab</button>
            <button onclick="stopPlayback()">Stop</button>
            <button onclick="saveTab()">Save Tab</button>
            <button onclick="loadTab()">Load Tab</button>
            <button onclick="exportMIDI()">Export MIDI</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <script>
        // script.js content (pasted here)
        import config from './config.js';

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Guitar Tab Editor loaded');
            // Initialize Tone.js
            try {
                Tone.start().then(() => {
                    console.log('Tone.js is ready');
                    loadTab(); // Load tab data after Tone.js is ready
                });
            } catch (error) {
                console.error('Tone.js initialization failed:', error);
                alert('Failed to initialize audio engine. Playback will not be available.');
            }
            setupUI();
            addMeasure(); // Call addMeasure to initialize the tab
            renderTab(); // Call renderTab after addMeasure to render the initial tab
        });

        let tabData = {
            measures: [],
            bpm: 120,
            tuning: ['E', 'A', 'D', 'G', 'B', 'E'],
            capo: 0
        };

        const standardTuning = [64, 59, 55, 50, 45, 40]; // [E4, B3, G3, D3, A2, E2]

        function setupUI() {
            const addMeasureButton = document.querySelector('.tool-bar button:nth-child(1)');
            const clearTabButton = document.querySelector('.tool-bar button:nth-child(2)');
            const playTabButton = document.querySelector('.tool-bar button:nth-child(5)');
            const stopTabButton = document.createElement('button');
            stopTabButton.textContent = 'Stop';
            stopTabButton.onclick = stopPlayback;
            stopTabButton.style.display = 'none'; // Initially hidden
            const toolBar = document.querySelector('.tool-bar');
            toolBar.insertBefore(stopTabButton, playTabButton.nextSibling);

            addMeasureButton.addEventListener('click', addMeasure);
            clearTabButton.addEventListener('click', clearTab);
            playTabButton.addEventListener('click', startPlayback);
        }

        function addMeasure() {
            console.log('addMeasure called'); // Log when addMeasure is called
            const measure = {
                strings: [
                    ['', '', '', ''],
                    ['', '', '', ''],
                    ['', '', '', ''],
                    ['', '', '', ''],
                    ['', '', '', ''],
                    ['', '', '', '']
                ]
            };
            tabData.measures.push(measure);
            console.log('tabData after addMeasure:', tabData); // Log tabData after adding a measure
            //renderTab(); // Removed renderTab call from here, as it's called in the DOMContentLoaded and clearTab
            renderTab(); // Re-render after adding a measure
        }

        function clearTab() {
            tabData.measures = [];
            renderTab();
        }

        function renderTab() {
            console.log('renderTab called'); // Log when renderTab is called
            console.log('tabData in renderTab:', tabData); // Log tabData at the start of renderTab
            const tabDisplay = document.getElementById('tab-display');
            tabDisplay.innerHTML = '';

            if (!tabData.measures || tabData.measures.length === 0) {
                console.log('No measures to render.');
                return; // Exit if there are no measures
            }

            try {
                tabData.measures.forEach((measure, measureIndex) => {
                    console.log('Rendering measure:', measureIndex, measure); // Log each measure being rendered
                    const measureDiv = document.createElement('div');
                    measureDiv.className = 'measure';

                    for (let stringIndex = 0; stringIndex < 6; stringIndex++) {
                        const stringDiv = document.createElement('div');
                        stringDiv.className = 'string';

                        for (let fretIndex = 0; fretIndex < 4; fretIndex++) {
                            const fretDiv = document.createElement('div');
                            fretDiv.className = 'fret';
                            fretDiv.contentEditable = true;
                            fretDiv.dataset.measure = measureIndex;
                            fretDiv.dataset.string = stringIndex;
                            fretDiv.dataset.fret = fretIndex;
                            fretDiv.textContent = measure.strings[stringIndex][fretIndex] || '';
                            fretDiv.addEventListener('input', handleFretInput);
                            fretDiv.addEventListener('click', (e) => {
                                showNumberCircle(e.target);
                            });
                            stringDiv.appendChild(fretDiv);
                        }
                        measureDiv.appendChild(stringDiv);
                    }
                    tabDisplay.appendChild(measureDiv);
                });
            } catch (error) {
                console.error('Error rendering tab:', error);
            }
        }

        function handleFretInput(e) {
            const measureIndex = parseInt(e.target.dataset.measure);
            const stringIndex = parseInt(e.target.dataset.string);
            const fretIndex = parseInt(e.target.dataset.fret);
            const value = e.target.textContent.replace(/[^0-9]/g, '').slice(0, 2); // Allow only numbers, max 2 digits

            if (tabData.measures[measureIndex]) {
                tabData.measures[measureIndex].strings[stringIndex][fretIndex] = value;
            }
            e.target.textContent = value; // Update the displayed text
        }

        let synth;
        let playbackInterval;
        let currentMeasureIndex = 0;
        let currentFretIndex = 0;
        let isPlaying = false;
        const playTabButton = document.querySelector('.tool-bar button:nth-child(5)');
        const stopTabButton = document.querySelector('.tool-bar button:nth-child(6)');

        function startPlayback() {
            if (isPlaying) return; // Prevent multiple playbacks
            isPlaying = true;
            playTabButton.style.display = 'none';
            stopTabButton.style.display = '';
            try {
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                const bpm = tabData.bpm || 120;
                const noteLength = (60 / bpm) * 4;
                currentMeasureIndex = 0;
                currentFretIndex = 0;
                playbackInterval = setInterval(() => {
                    playBeat();
                    currentFretIndex++;
                    if (currentFretIndex >= 4) {
                        currentFretIndex = 0;
                        currentMeasureIndex++;
                        if (currentMeasureIndex >= tabData.measures.length) {
                            stopPlayback();
                        }
                    }
                }, noteLength / 4 * 1000); // Convert to milliseconds
            } catch (error) {
                console.error('Playback initialization failed:', error);
                alert('Failed to initialize audio playback. Please check your browser settings.');
                stopPlayback(); // Ensure playback stops if initialization fails
            }
        }

        function playBeat() {
            if (!tabData.measures[currentMeasureIndex]) return;
            const measure = tabData.measures[currentMeasureIndex];
            for (let stringIndex = 0; stringIndex < 6; stringIndex++) {
                const fretValue = measure.strings[stringIndex][currentFretIndex];
                const fretNumber = parseInt(fretValue);
                if (!isNaN(fretNumber)) {
                    const note = getNote(stringIndex, fretNumber);
                    try {
                        synth.triggerAttackRelease(note, '16n'); // Play for a 16th note
                    } catch (error) {
                        console.error('Error triggering note:', error);
                    }
                }
            }
        }

        function stopPlayback() {
            if (!isPlaying) return;
            isPlaying = false;
            clearInterval(playbackInterval);
            playTabButton.style.display = '';
            stopTabButton.style.display = 'none';
            if (synth) {
                synth.releaseAll(); // Stop any lingering notes
                synth.dispose(); // Dispose of the synth to free up resources
                synth = null; // Set synth to null to prevent further use
            }
            currentMeasureIndex = 0;
            currentFretIndex = 0;
        }

        function getNote(stringIndex, fretNumber) {
            const notes = ['E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C', 'C#', 'D', 'D#'];
            const baseNote = tabData.tuning[stringIndex];
            const baseIndex = notes.indexOf(baseNote);
            const noteIndex = (baseIndex + fretNumber) % 12;
            const octave = Math.floor((baseIndex + fretNumber) / 12) + 2; // Determine octave
            return notes[noteIndex] + octave;
        }

        function saveTab() {
            localStorage.setItem('tabData', JSON.stringify(tabData));
        }

        function loadTab() {
            const savedTabData = localStorage.getItem('tabData');
            if (savedTabData) {
                tabData = JSON.parse(savedTabData);
            }
            renderTab();
        }

        function exportMIDI() {
            // Placeholder for MIDI export
            alert('MIDI export not yet implemented.');
        }

        function showBPMInput() {
            // Create the input element
            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'bpmInput';
            input.value = tabData.bpm; // Set the current BPM as the default value
            input.min = 40; // Set a minimum BPM value
            input.max = 240; // Set a maximum BPM value
            input.style.width = '50px'; // Adjust width as needed
            input.style.marginRight = '10px'; // Add some spacing

            // Create the button to set the BPM
            const setBPMButton = document.createElement('button');
            setBPMButton.textContent = 'Set BPM';
            setBPMButton.onclick = () => {
                const newBPM = parseInt(input.value);
                if (!isNaN(newBPM) && newBPM >= 40 && newBPM <= 240) {
                    tabData.bpm = newBPM;
                    // Optionally, provide feedback to the user, e.g., by updating a display element
                    console.log('BPM set to:', tabData.bpm);
                    // Remove the input and button after setting the BPM
                    bpmInputContainer.remove();
                } else {
                    alert('Please enter a valid BPM between 40 and 240.');
                }
            };

            // Create a container for the input and button
            const bpmInputContainer = document.createElement('div');
            bpmInputContainer.id = 'bpmInputContainer';
            bpmInputContainer.style.marginTop = '10px'; // Add some spacing
            bpmInputContainer.appendChild(input);
            bpmInputContainer.appendChild(setBPMButton);

            // Append the container to the tool-bar
            const toolBar = document.querySelector('.tool-bar');
            toolBar.appendChild(bpmInputContainer);
        }

        function showNumberCircle(fret) {
            // Remove any existing number circle before showing a new one
            let existingCircle = fret.querySelector('.number-circle');
            const openNumberCircle = document.querySelector('.number-circle');
            if (openNumberCircle) {
                existingCircle = openNumberCircle; // if another number circle is open, target that one for removal
                existingCircle.remove();
            }

            const circle = document.createElement('div');
            circle.className = 'number-circle';
            const radius = 50;
            const centerX = fret.offsetWidth / 2;
            const centerY = fret.offsetHeight / 2;

            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '1x', '2x'];

            numbers.forEach((num, i) => {
                const angle = (i / numbers.length) * 2 * Math.PI;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const number = document.createElement('div');
                number.className = 'number';
                number.textContent = num;
                number.style.left = `${x}px`;
                number.style.top = `${y}px`;
                number.style.animationDelay = `${i * 0.1}s`;

                number.onclick = () => {
                    if (num === '1x' || num === '2x') {
                        // If 1x or 2x is clicked, show the second number circle
                        circle.remove();
                        showSecondNumberCircle(fret, num);
                    } else {
                        // Otherwise, just set the fret text to the chosen number
                        fret.textContent = num;
                        circle.remove();
                    }
                };

                circle.appendChild(number);
            });

            // Append number circle to the body to avoid clipping
            document.body.appendChild(circle);
            // Position the number circle relative to the fret
            const fretRect = fret.getBoundingClientRect();
            circle.style.top = `${fretRect.top + window.scrollY - circle.offsetHeight / 2 + fret.offsetHeight / 2}px`; // Adjusted vertical positioning
            circle.style.left = `${fretRect.left + window.scrollX - circle.offsetWidth / 2 + fret.offsetWidth / 2}px`; // Adjusted horizontal positioning
        }

        // Add event listener to document to close number circle when clicking outside
        document.addEventListener('click', function(event) {
            const numberCircle = document.querySelector('.number-circle');
            if (numberCircle) {
                let isClickInside = numberCircle.contains(event.target);
                let isClickOnFret = event.target.classList.contains('fret');

                if (!isClickInside && !isClickOnFret) {
                    // Add a small delay before removing the number circle, but only if it's NOT the second number circle
                    setTimeout(() => {
                        if (!event.target.closest('.number-circle')) { // Double check if click is still outside any number-circle after delay
                            numberCircle.remove();
                        }
                    }, 100); // 100 milliseconds delay
                }
            }
        });

        function showSecondNumberCircle(fret, firstDigit) {
            // Remove any existing number circle
            let existingCircle = fret.querySelector('.number-circle');
            if (existingCircle) {
                existingCircle.remove();
            }

            const circle = document.createElement('div');
            circle.className = 'number-circle';
            circle.classList.add('second-number-circle'); // Add the new class here
            const radius = 50;
            const centerX = fret.offsetWidth / 2;
            const centerY = fret.offsetHeight / 2;

            const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            numbers.forEach((num, i) => {
                const angle = (i / numbers.length) * 2 * Math.PI;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const number = document.createElement('div');
                number.className = 'number';
                number.textContent = num;
                number.style.left = `${x}px`;
                number.style.top = `${y}px`;
                number.style.animationDelay = `${i * 0.1}s`;

                number.onclick = () => {
                    // Replace 'x' with the chosen number in the first digit
                    fret.textContent = firstDigit.replace(/x/, num); // Use regex to replace only the first 'x'
                    circle.remove(); // Remove the second number circle after number selection
                };

                circle.appendChild(number);
            });

            // Append number circle to the body to avoid clipping, same as first circle
            document.body.appendChild(circle);
            // Position the second number circle relative to the fret
            const fretRect = fret.getBoundingClientRect(); // Comment out original fretRect code
            circle.style.top = `${fretRect.top + window.scrollY - circle.offsetHeight / 2 + fret.offsetHeight / 2}px`; // Adjusted vertical positioning
            circle.style.left = `${fretRect.left + window.scrollX - circle.offsetWidth / 2 + fret.offsetWidth / 2}px`; // Adjusted horizontal positioning
        }
    </script>
</body>
</html>
